<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI íˆ¬ì ì§€ëŠ¥ ì‹œìŠ¤í…œ | AI Hedge Fund</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #b0b0b0;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .scenario-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .scenario-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .scenario-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }

        .scenario-type {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .scenario-type.optimistic {
            background: #10b981;
        }

        .scenario-type.neutral {
            background: #3b82f6;
        }

        .scenario-type.pessimistic {
            background: #ef4444;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid #667eea;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(255, 255, 255, 0.05);
            color: #667eea;
            font-weight: 600;
        }

        .action-buy {
            color: #10b981;
            font-weight: bold;
        }

        .action-sell {
            color: #ef4444;
            font-weight: bold;
        }

        .allocation-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .allocation-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric-label {
            color: #b0b0b0;
        }

        .metric-value {
            font-weight: bold;
            color: #e0e0e0;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-button">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

        <header>
            <h1>ğŸ§  AI íˆ¬ì ì§€ëŠ¥ ì‹œìŠ¤í…œ</h1>
            <p class="subtitle">ê²½ì œ ë¶„ì„ ê¸°ë°˜ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ë° ìì‚° ë°°ë¶„ ìµœì í™”</p>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('scenarios')">íˆ¬ì ì‹œë‚˜ë¦¬ì˜¤</button>
            <button class="tab-button" onclick="showTab('portfolio')">í¬íŠ¸í´ë¦¬ì˜¤</button>
            <button class="tab-button" onclick="showTab('performance')">ì„±ê³¼ ë¶„ì„</button>
            <button class="tab-button" onclick="showTab('learning')">AI í•™ìŠµ</button>
        </div>

        <!-- ì‹œë‚˜ë¦¬ì˜¤ íƒ­ -->
        <div id="scenarios-tab" class="tab-content active">
            <div class="card">
                <h2>ğŸ“Š íˆ¬ì ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±</h2>
                <p style="margin-bottom: 20px; color: #b0b0b0;">
                    í˜„ì¬ ê²½ì œ ìƒí™©ì„ ë¶„ì„í•˜ì—¬ AIê°€ íˆ¬ì ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                </p>
                <button class="btn btn-primary" onclick="generateScenarios()">
                    ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± (3ê°œ)
                </button>
            </div>

            <div id="scenarios-loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p style="margin-top: 20px;">AIê°€ ê²½ì œ ì§€í‘œë¥¼ ë¶„ì„í•˜ê³  ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>

            <div id="scenarios-list"></div>
        </div>

        <!-- í¬íŠ¸í´ë¦¬ì˜¤ íƒ­ -->
        <div id="portfolio-tab" class="tab-content">
            <div class="card">
                <h2>ğŸ’¼ í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤</h2>
                <div id="current-portfolio-display"></div>
            </div>

            <div class="card">
                <h2>ğŸ”„ ë¦¬ë°¸ëŸ°ì‹± ê³„íš</h2>
                <p style="margin-bottom: 20px; color: #b0b0b0;">
                    ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ê³  ë¦¬ë°¸ëŸ°ì‹± ê³„íšì„ í™•ì¸í•˜ì„¸ìš”.
                </p>
                <div id="rebalancing-plan"></div>
            </div>
        </div>

        <!-- ì„±ê³¼ ë¶„ì„ íƒ­ -->
        <div id="performance-tab" class="tab-content">
            <div class="card">
                <h2>ğŸ“ˆ ì„±ê³¼ ë¶„ì„</h2>
                <p style="margin-bottom: 20px; color: #b0b0b0;">
                    ì„ íƒí•œ ì‹œë‚˜ë¦¬ì˜¤ì˜ ì‹¤ì œ ì„±ê³¼ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.
                </p>
                <div id="performance-results"></div>
            </div>
        </div>

        <!-- AI í•™ìŠµ íƒ­ -->
        <div id="learning-tab" class="tab-content">
            <div class="card">
                <h2>ğŸ¤– AI ëª¨ë¸ ê°€ì¤‘ì¹˜</h2>
                <p style="margin-bottom: 20px; color: #b0b0b0;">
                    AIê°€ í•™ìŠµí•œ í‚¤ì›Œë“œ ê°€ì¤‘ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <button class="btn btn-primary" onclick="loadAIWeights()">
                    ê°€ì¤‘ì¹˜ ì¡°íšŒ
                </button>
                <div id="ai-weights-display"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedScenario = null;
        let token = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° í™•ì¸
        window.addEventListener('DOMContentLoaded', () => {
            token = localStorage.getItem('token');
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }

            loadScenarios();
            loadCurrentPortfolio();
        });

        // íƒ­ ì „í™˜
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        // API í˜¸ì¶œ í—¬í¼
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(endpoint, options);
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'API í˜¸ì¶œ ì‹¤íŒ¨');
            }

            return await response.json();
        }

        // ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±
        async function generateScenarios() {
            const loadingDiv = document.getElementById('scenarios-loading');
            const listDiv = document.getElementById('scenarios-list');

            loadingDiv.style.display = 'block';
            listDiv.innerHTML = '';

            try {
                const result = await apiCall('/api/intelligence/scenarios/generate', 'POST', {
                    num_scenarios: 3
                });

                loadingDiv.style.display = 'none';

                if (result.success) {
                    displayScenarios(result.scenarios);
                    showSuccessMessage('ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ì™„ë£Œ!');
                }
            } catch (error) {
                loadingDiv.style.display = 'none';
                showErrorMessage('ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡ ë¡œë“œ
        async function loadScenarios() {
            try {
                const result = await apiCall('/api/intelligence/scenarios/list');
                if (result.success && result.scenarios.length > 0) {
                    displayScenarios(result.scenarios);
                }
            } catch (error) {
                console.error('ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì‹œë‚˜ë¦¬ì˜¤ í‘œì‹œ
        function displayScenarios(scenarios) {
            const listDiv = document.getElementById('scenarios-list');
            listDiv.innerHTML = '<div class="card"><h2>ğŸ“‹ ìƒì„±ëœ ì‹œë‚˜ë¦¬ì˜¤</h2><div class="scenario-grid" id="scenario-grid"></div></div>';

            const gridDiv = document.getElementById('scenario-grid');

            scenarios.forEach(scenario => {
                const card = document.createElement('div');
                card.className = 'scenario-card';
                card.onclick = () => selectScenario(scenario);

                const typeClass = scenario.scenario_type === 'ë‚™ê´€ì ' ? 'optimistic' :
                                 scenario.scenario_type === 'ë¹„ê´€ì ' ? 'pessimistic' : 'neutral';

                card.innerHTML = `
                    <span class="scenario-type ${typeClass}">${scenario.scenario_type}</span>
                    <h3 style="margin: 10px 0;">${scenario.scenario_name}</h3>
                    <p style="color: #b0b0b0; margin-bottom: 15px;">${scenario.description || ''}</p>
                    <div class="metric">
                        <span class="metric-label">ë°œìƒ í™•ë¥ </span>
                        <span class="metric-value">${(scenario.probability * 100).toFixed(0)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">ì˜ˆìƒ ìˆ˜ìµë¥ </span>
                        <span class="metric-value">${scenario.expected_return?.toFixed(1) || 'N/A'}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">ë¦¬ìŠ¤í¬ ìˆ˜ì¤€</span>
                        <span class="metric-value">${scenario.risk_level}</span>
                    </div>
                `;

                gridDiv.appendChild(card);
            });
        }

        // ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ
        function selectScenario(scenario) {
            selectedScenario = scenario;

            document.querySelectorAll('.scenario-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            showSuccessMessage(`"${scenario.scenario_name}" ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒë¨`);

            // í¬íŠ¸í´ë¦¬ì˜¤ íƒ­ìœ¼ë¡œ ì „í™˜í•˜ì—¬ ë¦¬ë°¸ëŸ°ì‹± ê³„íš í‘œì‹œ
            showTab('portfolio');
            loadRebalancingPlan(scenario.id);
        }

        // í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë“œ
        async function loadCurrentPortfolio() {
            try {
                const result = await apiCall('/api/intelligence/portfolio/current');
                if (result.success && result.portfolio) {
                    displayCurrentPortfolio(result.portfolio);
                }
            } catch (error) {
                console.error('í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // í¬íŠ¸í´ë¦¬ì˜¤ í‘œì‹œ
        function displayCurrentPortfolio(portfolio) {
            const displayDiv = document.getElementById('current-portfolio-display');

            if (!portfolio || portfolio.total_value === 0) {
                displayDiv.innerHTML = '<p style="color: #b0b0b0;">í¬íŠ¸í´ë¦¬ì˜¤ ì—†ìŒ</p>';
                return;
            }

            let html = `
                <div class="metric">
                    <span class="metric-label">ì´ ê°€ì¹˜</span>
                    <span class="metric-value">$${portfolio.total_value.toLocaleString()}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">í˜„ê¸ˆ</span>
                    <span class="metric-value">$${portfolio.cash_balance.toLocaleString()}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">ë¦¬ìŠ¤í¬ ì„±í–¥</span>
                    <span class="metric-value">${portfolio.risk_tolerance}</span>
                </div>
                <h3 style="margin-top: 20px; color: #667eea;">ë³´ìœ  ì¢…ëª©</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ì¢…ëª©</th>
                            <th>ì£¼ì‹ ìˆ˜</th>
                            <th>í˜„ì¬ê°€</th>
                            <th>í‰ê°€ì•¡</th>
                            <th>ì†ìµë¥ </th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            portfolio.holdings.forEach(holding => {
                const pnlColor = holding.unrealized_pnl_pct >= 0 ? '#10b981' : '#ef4444';
                html += `
                    <tr>
                        <td>${holding.ticker}</td>
                        <td>${holding.shares.toFixed(2)}</td>
                        <td>$${holding.current_price.toFixed(2)}</td>
                        <td>$${holding.current_value.toLocaleString()}</td>
                        <td style="color: ${pnlColor}">${holding.unrealized_pnl_pct.toFixed(2)}%</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            displayDiv.innerHTML = html;
        }

        // ë¦¬ë°¸ëŸ°ì‹± ê³„íš ë¡œë“œ
        async function loadRebalancingPlan(scenarioId) {
            // TODO: ì‹¤ì œ í¬íŠ¸í´ë¦¬ì˜¤ ë°ì´í„°ë¡œ êµì²´
            const samplePortfolio = {
                scenario_id: scenarioId,
                total_value: 10000000,
                cash_balance: 2000000,
                holdings: [
                    {ticker: "AAPL", shares: 10, avg_price: 150, current_price: 180, current_value: 1800000, weight_pct: 18},
                    {ticker: "TSLA", shares: 15, avg_price: 200, current_price: 250, current_value: 3750000, weight_pct: 37.5}
                ],
                risk_tolerance: "ë³´í†µ"
            };

            try {
                const result = await apiCall('/api/intelligence/portfolio/rebalance', 'POST', samplePortfolio);

                if (result.success) {
                    displayRebalancingPlan(result);
                }
            } catch (error) {
                showErrorMessage('ë¦¬ë°¸ëŸ°ì‹± ê³„íš ìƒì„± ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ë¦¬ë°¸ëŸ°ì‹± ê³„íš í‘œì‹œ
        function displayRebalancingPlan(plan) {
            const planDiv = document.getElementById('rebalancing-plan');

            let html = `
                <div class="success">${plan.summary}</div>
                <div class="metric">
                    <span class="metric-label">ì˜ˆìƒ ê±°ë˜ ë¹„ìš©</span>
                    <span class="metric-value">$${plan.estimated_total_cost.toLocaleString()}</span>
                </div>
                <h3 style="margin-top: 20px; color: #667eea;">ë¦¬ë°¸ëŸ°ì‹± ì•¡ì…˜</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ì•¡ì…˜</th>
                            <th>ì¢…ëª©</th>
                            <th>í˜„ì¬ ì£¼ì‹ ìˆ˜</th>
                            <th>ëª©í‘œ ì£¼ì‹ ìˆ˜</th>
                            <th>ë³€ê²½</th>
                            <th>ì˜ˆìƒ ë¹„ìš©</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            plan.actions.forEach(action => {
                if (action.action === 'HOLD') return;

                const actionClass = action.action === 'BUY' ? 'action-buy' : 'action-sell';
                html += `
                    <tr>
                        <td class="${actionClass}">${action.action}</td>
                        <td>${action.ticker}</td>
                        <td>${action.current_shares.toFixed(2)}</td>
                        <td>${action.target_shares.toFixed(2)}</td>
                        <td>${action.shares_change > 0 ? '+' : ''}${action.shares_change.toFixed(2)}</td>
                        <td>$${action.estimated_cost.toLocaleString()}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            planDiv.innerHTML = html;
        }

        // AI ê°€ì¤‘ì¹˜ ë¡œë“œ
        async function loadAIWeights() {
            try {
                const result = await apiCall('/api/intelligence/learning/weights');

                if (result.success) {
                    displayAIWeights(result.weights);
                }
            } catch (error) {
                showErrorMessage('AI ê°€ì¤‘ì¹˜ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // AI ê°€ì¤‘ì¹˜ í‘œì‹œ
        function displayAIWeights(weights) {
            const displayDiv = document.getElementById('ai-weights-display');

            let html = `
                <table style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>í‚¤ì›Œë“œ</th>
                            <th>ì¹´í…Œê³ ë¦¬</th>
                            <th>ê°€ì¤‘ì¹˜</th>
                            <th>ì„±ê³µ/ì‹¤íŒ¨</th>
                            <th>ì‹ ë¢°ë„</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            weights.forEach(weight => {
                const successRate = weight.total_count > 0 ? (weight.success_count / weight.total_count * 100) : 0;
                html += `
                    <tr>
                        <td>${weight.keyword}</td>
                        <td>${weight.category}</td>
                        <td>
                            ${weight.weight.toFixed(2)}
                            <div class="allocation-bar">
                                <div class="allocation-fill" style="width: ${weight.weight * 100}%"></div>
                            </div>
                        </td>
                        <td>${weight.success_count}/${weight.failure_count}</td>
                        <td>${(weight.confidence * 100).toFixed(0)}%</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            displayDiv.innerHTML = html;
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showSuccessMessage(message) {
            // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
            document.querySelectorAll('.success, .error').forEach(el => el.remove());

            const div = document.createElement('div');
            div.className = 'success';
            div.textContent = message;

            document.querySelector('.container').insertBefore(div, document.querySelector('.tabs'));

            setTimeout(() => div.remove(), 5000);
        }

        function showErrorMessage(message) {
            document.querySelectorAll('.success, .error').forEach(el => el.remove());

            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = message;

            document.querySelector('.container').insertBefore(div, document.querySelector('.tabs'));

            setTimeout(() => div.remove(), 5000);
        }
    </script>
</body>
</html>
